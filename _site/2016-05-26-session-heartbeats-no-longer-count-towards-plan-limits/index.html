<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My Blog</title>
</head>
<body>
<h1>Session Heartbeats No Longer Count Towards Plan Limits</h1>

<p><img loading="lazy" class="alignright size-full wp-image-14475" style="margin-left: 15px;" src="http://exceptionless.com/assets/session-tracking-revised.png" alt="session-tracking-revised" width="260" height="260" data-id="14475" srcset="https://exceptionless.com/assets/session-tracking-revised.png 260w, https://exceptionless.com/assets/session-tracking-revised-150x150.png 150w" sizes="(max-width: 260px) 100vw, 260px" />That’s right! We’ve re-imagined how session heartbeats and session end events should work on the back end and were able to make them much more efficient, allowing us to stop counting them toward user plan limits!</p>
<p>This blog post explains our original goals and implementation of these session events, and how we were able to retain the same functionality of the feature while limiting resource usage.</p>
<p>Our hope is that this will obviously make our users happy, but also that all the developers out there can benefit from our process and solution.<!--more--></p>
<h2>Genesis: Exceptionless Session Tracking</h2>
<p>In the beginning, we set out to create a sessions feature that allowed our users to submit a session start event and the session would be automatically updated by sending a session heartbeat event, as well as a session end event, respectively.</p>
<p>These session heartbeats and session end events were meant to be session markers to show that a user was active or a session had ended.</p>
<p>We wanted to <strong>leverage our existing infrastructure,</strong> and the easiest way to do so was to introduce new event types that we recognized. This meant that these events went through the client side plugins (extra work) and server side processing. As such, there was <strong>no way to tell these events apart from any other event</strong>.</p>
<p>And because of that, they counted against user plan limits.</p>
<h2>Noise</h2>
<p>After releasing the sessions feature, <strong>it didn’t take us long to notice that the heartbeats were noise</strong>. However, we knew that users wanted to see what their customers or users were doing while being active throughout the session, so we didn’t remove them.</p>
<p>We knew they were counting towards plan limits, causing some users to reach theirs quickly, and we knew they were adding noise, thus limiting the feature’s value, but we also wanted to keep the feature alive because of the <em>potential</em> value offered. So, we had to react and make the entire feature more feasible, streamlined, and cheap.</p>
<h2>Back to the Drawing Board</h2>
<p>We did some thinking (and coding), trying to determine the best way we could <strong>provide end users with a great session tracking feature without over-taxing our system</strong> in the process, and we were able to come up with a solution!</p>
<p>So, we created a new GET API endpoint <code>/api/v2/events/session/heartbeat</code> (<a href="https://api.exceptionless.io/docs/index#!/Event/Event_RecordHeartbeatAsync">api source</a>) that takes a session id or user id and a flag if the session is closed. This API endpoint then sets a unique session cache key with the current time.</p>
<p>Our existing <code>CloseInactiveSessionsJob.cs</code> was already periodically polling for open sessions to check for inactive sessions so it could automatically close them after a period of time if no session end event was sent, so we just updated this job to check for the unique session cache keys (<a href="https://github.com/exceptionless/Exceptionless/blob/master/Source/Core/Jobs/CloseInactiveSessionsJob.cs#L43">source</a>) and get the last time a heartbeat was sent in or see if it was closed. It then takes the appropriate action and updates the session event.</p>
<p>Then we just updated the clients to call this new API endpoint when <code>client.Submit.SessionHeartbeat(&quot;id&quot;)</code> or <code>client.SubmitSessionEnd(&quot;id&quot;)</code> is called.</p>
<h2>Efficiency Achieved!</h2>
<p>Our new solution gives us the ability to have clients send us session heartbeat and session end information very efficiently, which lets us provide a great session tracking feature <strong>without adding any additional cost</strong> to our plans!</p>
<p>That’s how we like to roll, and we hope you find value from the feature and our run down of the process we went through to get it to our users.</p>
<h3>Don’t Forget to Update Your Client</h3>
<p>If you haven’t already updated your client, please do so to start taking advantage of the free session events.</p>
<p>And, as always, please let us know if you’ve got any feedback or questions. We’d love to hear from you!</p>

</body>
</html>
